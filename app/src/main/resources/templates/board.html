<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Xadrez 4 Jogadores</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link rel="stylesheet" href="/style.css">
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

<div id="game-container" class="game-container">
    <h1>Xadrez 4 Jogadores</h1>
    
    <div id="game-state-and-board" th:fragment="game-state-and-board"> 
        
        <div id="status-bar" class="status-bar">
            <div>
                Turno: 
                <span th:text="${currentTurn}" 
                      th:class="'turn-indicator ' + ${currentTurn.toString().toLowerCase()}">
                      VERDE
                </span>
                <span th:if="${gameOver}" class="game-over-msg"> - JOGO ACABOU</span>
            </div>
            
            <div class="button-group">
                <button class="reset-btn" 
                        hx-post="/reset" 
                        hx-target="#game-container" 
                        hx-swap="outerHTML">
                    üîÑ Novo Jogo
                </button>
                
                <!-- Modal para salvar jogo -->
                <button class="save-btn" 
                        onclick="document.getElementById('saveModal').style.display='block'">
                    üíæ Salvar
                </button>
                
                <!-- Bot√£o para carregar jogo -->
                <button class="load-btn" 
                        onclick="window.location.href='/saved-games'">
                    üìÅ Carregar
                </button>
            </div>
        </div>
        
        <!-- Modal de Salvamento -->
        <div id="saveModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2a2a2a; padding: 30px; border-radius: 10px; min-width: 400px;">
                <h3 style="margin-top: 0; color: #4aff4a;">üíæ Salvar Jogo</h3>
                
                <form onsubmit="saveGame(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px;">Nome do Jogo:</label>
                        <input type="text" 
                               name="gameName" 
                               id="gameNameInput"
                               placeholder="Digite um nome para o jogo"
                               style="width: 100%; padding: 10px; border: none; border-radius: 5px; background: #333; color: white;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" 
                                onclick="closeSaveModal()" 
                                style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" 
                                style="padding: 10px 20px; background: #4aff4a; color: black; border: none; border-radius: 5px; cursor: pointer;">
                            üíæ Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 
           USO DO STYLE INLINE PARA ROTA√á√ÉO INFINITA 
           Removemos as classes 'rotate-X' e usamos a vari√°vel calculada no Java.
           Isso permite ir de -270 para -360 suavemente.
        -->
        <div id="board" 
             th:style="'transform: rotate(' + ${boardRotation} + 'deg)'"
             th:class="${doTransition} ? 'board-grid-with-transition' : 'board-grid'">
            
            <th:block th:each="row : ${grid}">
                <div th:each="sq : ${row}" 
                     th:class="'cell ' + ${sq.getCssClass()}"
                     
                     th:attr="hx-get=${sq.hxVerb == 'get'} ? ${sq.hxUrl} : null,
                              hx-post=${sq.hxVerb == 'post'} ? ${sq.hxUrl} : null"
                     
                     hx-target="#game-state-and-board" 
                     hx-select="#game-state-and-board" 
                     hx-swap="outerHTML">
                     
                     <!-- 
                        CONTRA-ROTA√á√ÉO DAS PE√áAS
                        Usamos o inverso da rota√ß√£o do tabuleiro (-boardRotation)
                        para manter as pe√ßas "em p√©".
                     -->
                     <div th:if="${sq.piece != null}" 
                          th:class="'piece ' + ${sq.getPieceColorClass()}"
                          th:style="'transform: rotate(' + (${boardRotation} * -1) + 'deg)'">
                         <span th:text="${sq.getSymbol()}">P</span>
                     </div>
                     
                     <div th:if="${sq.isTarget}" class="move-marker"></div>
                </div>
            </th:block>
        </div>
        
        <div class="instructions">
            <p>O tabuleiro gira automaticamente para o jogador atual.</p>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    console.log('üéÆ Jogo de xadrez carregado!');
    
    function saveGame(event) {
        event.preventDefault();
        const gameName = document.getElementById('gameNameInput').value;
        if (!gameName.trim()) {
            alert('Por favor, digite um nome para o jogo.');
            return;
        }
        
        // Fazer a requisi√ß√£o de salvamento
        fetch('/save-game-json?name=' + encodeURIComponent(gameName), {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensagem de sucesso tempor√°ria
                showMessage('üéÆ ' + data.message, 'success');
                closeSaveModal();
            } else if (data.error) {
                // Mostrar mensagem de erro
                showMessage('‚ùå ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erro ao salvar:', error);
            showMessage('‚ùå Erro ao salvar o jogo.', 'error');
        });
    }
    
    function showMessage(message, type) {
        // Criar elemento de mensagem
        const messageEl = document.createElement('div');
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            background: ${type === 'success' ? '#4aff4a' : '#ff4a4a'};
            color: ${type === 'success' ? 'black' : 'white'};
        `;
        messageEl.textContent = message;
        
        // Adicionar ao documento
        document.body.appendChild(messageEl);
        
        // Remover ap√≥s 3 segundos
        setTimeout(() => {
            messageEl.remove();
        }, 3000);
    }
    
    function closeSaveModal() {
        document.getElementById('saveModal').style.display = 'none';
        document.getElementById('gameNameInput').value = '';
    }
</script>

</body>
</html>